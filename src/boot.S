;; ************************************************************************
;;  マクロ
;; ************************************************************************
%include "./include/define.S"
%include "./include/macro.S"

	ORG	BOOT_LOAD

;; ************************************************************************
;;  エントリポイント
;; ************************************************************************
entry:	
	jmp	ipl

	;; BIOS Parameter Block (nop埋め)
	times	90 - ($ - $$) db 0x90

ipl:
	cli
	;; セグメントレジスタの初期化
	mov	ax, 0x0000
	mov	ds, ax
	mov	es, ax
	mov	ss, ax
	;; スタックポインタの設定
	mov	sp, BOOT_LOAD
	sti

	;; ---------------------------------------
	;;  ブートドライブ番号を保存
	;; ---------------------------------------
	mov	[BOOT + drive.no], dl		; ブートドライブを保存

	;; ---------------------------------------
	;;  残りのセクタをすべて読み込む
	;; ---------------------------------------
	mov 	bx, BOOT_SECT - 1 		; BX = 残りのブートセクタ数;
	mov 	cx, BOOT_LOAD + SECT_SIZE 	; CX = 次のロードアドレス;
	cdecl	read_chs, BOOT, bx, cx  	; AX = read_chs(BOOT, BX, CX);

	cmp	ax, bx 				; if (AX != 残りのセクタ数)
.10Q:	jz	.10E				; {
.10T:	cdecl	puts, .e0			;   puts(.e0);
	call	reboot				;   reboot(); // 再起動
.10E:						; }

	;; ---------------------------------------
	;;  次のステージへ移行
	;; ---------------------------------------
	jmp	stage_2

.s0	db 	"Booting...", 0x0A, 0x0D, 0x00
.e0	db	"Error : sector read", 0x00

;; ************************************************************************
;;  ブートドライブに関する情報
;; ************************************************************************
BOOT:
	istruc drive
	    at drive.no,   dw 0		; ドライブ番号
	    at drive.cyln, dw 0 	; C:シリンダ
	    at drive.head, dw 0 	; H:ヘッド
	    at drive.sect, dw 2 	; S:セクタ
	iend

;; ************************************************************************
;;  モジュール
;; ************************************************************************
%include	"./modules/real/puts.S"
%include	"./modules/real/itoa.S"
%include	"./modules/real/reboot.S"
%include	"./modules/real/read_chs.S"

;; ************************************************************************
;;  ブートフラグ
;; ************************************************************************
	times	510 - ($ - $$) db 0x00
	db 	0x55, 0xAA

;; ************************************************************************
;;  ブート処理の第2ステージ
;; ************************************************************************
stage_2:
	cdecl	puts, .s0
	jmp 	$
.s0	db	"2nd stage...", 0x0A, 0x0D, 0x00

;; ************************************************************************
;;  パディング
;; ************************************************************************
	times	BOOT_SIZE - ($ - $$) db 0x00
